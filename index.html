<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instagram clone</title>
<!-- LINKS -->
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

<!-- Basic Logo -->
<link rel="icon" href="../assets/images/logo.png" type="image/png">




</head>
<body>
<!-- CONTAINER -->
<div class="container">
<div class="sidebar">

  
<div class="logo">
<p>Instagram</p>
</div>
<nav class="navbar-menu">
<ul>
<li>
<a href="#"><i class="fa-solid fa-house"></i>Home</a>
</li>

<li>
<a href="#"><i class="fa-solid fa-magnifying-glass"></i>Search</a>
</li>

<li>
<a href="#"><i class="fa-solid fa-compass"></i>Explore</a>
</li>

<li>
<a href="#"><i class="fa-solid fa-clapperboard"></i>Reels</a>
</li>

<li>
<a href="#"><i class="fa-brands fa-facebook-messenger"></i>Messages</a>
</li>

<li>
<a href="#"><i class="fa-regular fa-heart"></i>Notification</a>
</li>

<li id="create">
<a href="#"><i class="fa-regular fa-square-plus"></i>Create</a>
</li>

<li>
<a href="#"><i class="fa-solid fa-square-poll-vertical"></i>Dashboard</a>
</li>

<li>
<a href="#"><i class="fa-solid fa-user"></i>Profile</a>
</li>


<li id="more-btn">
<a href="#"><i class="fa-solid fa-bars" ></i>More</a>
</li>
</ul>

</nav>
<!-- Switch-account-container-->
<div class="switch-accounts-container " id="switch-accounts-container">
<div class="menu-item"><i class="fa-solid fa-gear"></i>Settings</div>
<div class="menu-item"><i class="fa-solid fa-chart-simple"></i>Your activity</div>
<div class="menu-item"><i class="fa-regular fa-bookmark"></i>Saved</div>
<div class="menu-item"><i class="fa-regular fa-moon"></i>Switch appearance</div>
<div class="menu-item"><i class="fa-solid fa-circle-exclamation"></i>Report a problem</div>

<div class="divider"></div>
<div class="menu-item"><i class="fa-brands fa-threads"></i>Threads</div>
<div class="divider"></div>

<div class="menu-item">Switch accounts</div>
<div class="menu-item" id="logout"><a href="/auth/login.html">logout</a></div>
</div>

<div class="switch-appearance-card"></div>

</div>
<!-- create-Post -->
 <div class="create-post-card" id="create-post">
    <ul>
      <li class="create-post-btn" id="openModal">
        <span>Post</span>
        <i class="fa-regular fa-images"></i>
        
      <li>
       <span>Live Video</span>
       <i class="fas fa-video"></i> 
      </li>
      <li>
        <span>Ad</span>
        <i class="fa-solid fa-coins"></i>
      </li>
      <li>
        <span>AI</span>
        <i class="fa-regular fa-user"></i>
      </li>
    </ul>
 </div>

<!-- MAIN -->
<main class="main-container">
<div class="stories">
<div class="story">
<img src="../assets/images/profile1.jpg">
<span id="name">Kelvin D</span>
</div>

<div class="story">
<img src="../assets/images/profile2.jpg">
<span id="name">vinisius</span>
</div>

<div class="story">
<img src="../assets/images/profile3.jpg">
<span id="name">Vedaste</span>
</div>

<div class="story">
<img src="../assets/images/profile4.jpg">
<span id="name">Lil john</span>
</div>

<div class="story">
<img src="../assets/images/profile5.jpg">
<span id="name">olivier</span>
</div>

<div class="story">
<img src="../assets/images/profile6.jpg">
<span id="name">emmy</span>
</div>
</div>

<div class="all-posts" id="all-posts"></div>

<!-- create new post modal -->
<div class="select-post" id="select-post">
  <form class="post-form">
    <h2>Select Post</h2>

    <div class="form-group">
      <label for="media">Select Photo or Video:</label>
      <input type="file" id="media" accept="image/*,video/*" style="display:none;" />
      <input type="text" id="fileURL" placeholder="Selected file URL..." readonly />
      <button type="button" onclick="document.getElementById('media').click()">Choose File</button>

      <img id="previewImage" style="margin-top:10px; max-width:100%; display:none;" />
    </div>

    <div class="form-group">
      <label for="description">Add Description:</label>
      <textarea id="description" maxlength="500" placeholder="Write your post description..."></textarea>
    </div>

    <div class="form-group">
      <button type="submit">Create Post</button>
    </div>
  </form>
</div>

</main>

<div class="right-profile">
<div class="profile-header">
<a href="profile.html"><img src="../assets/images/profile2.jpg" class="profile-photo"></a>
<div class="profile-info">
<h3 class="username">jean claude</h3>
<p>olivier_Gram</p>
</div>
<div class="switch-account">
<a href="#">switch</a>
</div>
</div>
<div class="right-suggest-header">
<p>Suggested for you</p>
<span><a href="#">See All</a></span>
</div>
<div class="right-suggest-profile">
<div class="user">
<img src="../assets/images/post-header2.jpeg">
<div class="user-name">
<span><a href="#">annick_funny olivier</a></span>
<p>Followed by eric b</p>
</div>
<div class="follow-btn">
<span><a href="#">Follow</a></span>
</div>
</div> 

<div class="user">
<img src="../assets/images/bako.webp">
<div class="user-name">
<span><a href="#">annick_funny</a></span>
<p>Followed by eric b</p>
</div>
<div class="follow-btn">
<span><a href="#">Follow</a></span>
</div>
</div> 

<div class="user">
<img src="../assets/images/suggest3.jpg">
<div class="user-name">
<span><a href="#">annick_funny</a></span>
<p>Followed by eric b</p>
</div>
<div class="follow-btn">
<span><a href="#">Follow</a></span>
</div>
</div> 

<div class="user">
<img src="../assets/images/movie.webp">
<div class="user-name">
<span><a href="#">annick_funny</a></span>
<p>Followed by eric b</p>
</div>
<div class="follow-btn">
<span><a href="#">Follow</a></span>
</div>
</div> 
</div>

<div class="links-btn">
<div class="links">
<span><a href="#">About</a></span>
<span>.</span>
<span><a href="#">Help</a></span>
<span>.</span>
<span><a href="#">Press</a></span>
<span>.</span>
<span><a href="#">API</a></span>
<span>.</span>
<span><a href="#">JObs</a></span>
<span>.</span>
<span><a href="#">Privacy</a></span>
<span>.</span>
<span><a href="#">Terms</a></span>
<span>.</span>
<span><a href="#">Locations</a></span>
<span>.</span>
<span><a href="#"></a></span>
<span>.</span>
<span><a href="#">Language</a></span>
<span>.</span>
<span><a href="#">Meta Verfied</a></span>
</div>
<div class="copy-right">
<p>&copy 2025 INSTAGRAM FROM META </p>
</div>
</div>

</div>
 <script>
// ============ AUTHENTICATION & PAGE PROTECTION ============
document.addEventListener("DOMContentLoaded", function () {
  const logoutBtn = document.getElementById("logout");

  if (logoutBtn) {
    logoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      sessionStorage.clear();
      sessionStorage.setItem("logoutMessage", "Logged out successfully");
      window.location.replace("/auth/login.html");
    });
  }

  // Block access to home if not logged in
  if (sessionStorage.getItem("isLoggedIn") !== "true") {
    window.location.replace("/auth/login.html");
  }

  // Prevent going back after logout
  window.history.pushState(null, null, window.location.href);
  window.onpopstate = function () {
    window.history.pushState(null, null, window.location.href);
  };
});

// ============ UI TOGGLES ============
const moreBtn = document.getElementById("more-btn");
const switchContainer = document.getElementById("switch-accounts-container");
const createPostBtn = document.getElementById("create");
const createPostCard = document.querySelector(".create-post-card");
const selectPost = document.getElementById("select-post");
const openPostOption = document.getElementById("openModal");


// Toggle "More" menu
moreBtn.addEventListener("click", e => {
  e.preventDefault();
  switchContainer.style.display = switchContainer.style.display === "block" ? "none" : "block";
  createPostCard.style.display = "none";
  e.stopPropagation();
});

// Toggle "Create" menu
createPostBtn.addEventListener("click", e => {
  e.preventDefault();
  createPostCard.style.display = createPostCard.style.display === "block" ? "none" : "block";
  switchContainer.style.display = "none";
  e.stopPropagation();
});

// Show "Select Post" modal
openPostOption.addEventListener("click", e => {
  e.preventDefault();
  selectPost.style.display = "block";
  createPostCard.style.display = "none";
  e.stopPropagation();
});

// Close menus/modals when clicking outside
document.addEventListener("click", e => {
  if (!switchContainer.contains(e.target) && !moreBtn.contains(e.target)) {
    switchContainer.style.display = "none";
  }
  if (!createPostCard.contains(e.target) && !createPostBtn.contains(e.target)) {
    createPostCard.style.display = "none";
  }
  if (selectPost.style.display === "" && !selectPost.contains(e.target) && !openPostOption.contains(e.target)) {
    selectPost.style.display = "none";
  }
});

// File preview
mediaInput.addEventListener("change", () => {
  if (mediaInput.files.length > 0) {
    const file = mediaInput.files[0];
    const tempURL = URL.createObjectURL(file);
    fileURL.value = tempURL;

    if (file.type.startsWith("image/")) {
      previewImages.src = tempURL;
      previewImages.style.display = "block";
    } else {
      previewImages.style.display = "none";
    }
  } else {
    fileURL.value = "";
    previewImages.style.display = "none";
  }
});

// ============ UTILITY FUNCTIONS ============
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

function formatLikeCount(count) {
  if (count >= 1000000) {
    return (count / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
  }
  if (count >= 1000) {
    return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
  }
  return count.toLocaleString();
}

function showNotification(message, type = "info") {
  const notification = document.createElement("div");
  notification.className = `notification ${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.opacity = "1", 10);
  
  setTimeout(() => {
    notification.style.opacity = "0";
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// ============ POST CREATION ============
postForm.addEventListener("submit", async e => {
  e.preventDefault();

  const file = mediaInput.files[0];
  const description = descriptionInput.value.trim();
  const username = sessionStorage.getItem("username") || "Anonymous";

  if (!file) {
    showNotification("Please select an image or video!", "error");
    return;
  }

  try {
    const base64Media = await toBase64(file);

    const newPost = {
      user: username,
      description: description,
      media: base64Media,
      type: file.type.startsWith("image/") ? "image" : "video",
      likes: 0,
      likedBy: [],
      comments: [],
      createdAt: new Date().toISOString()
    };

    const res = await fetch("http://localhost:3000/posts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newPost)
    });

    if (!res.ok) throw new Error("Failed to save post");

    const savedPost = await res.json();

    // Add new post to UI immediately
    const postEl = document.createElement("div");
    postEl.classList.add("post");
    postEl.dataset.id = savedPost.id;
    
    postEl.innerHTML = `
      <div class="post-images">
        <div class="post-header">
          <img src="../assets/images/profile1.jpg" alt="profile">
          <span class="username">${savedPost.user}</span>
          <p class="post-time">just now</p>
          <i class="fa-solid fa-ellipsis"></i>
        </div>
        <div class="post-img">
          ${savedPost.type === "image" 
            ? `<img src="${savedPost.media}" alt="post image">`
            : `<video controls src="${savedPost.media}"></video>`
          }
        </div>
        <div class="post-actions">
          <div class="post-comment">
            <i class="fa-regular fa-heart like-btn"></i>
            <i class="fa-regular fa-comment"></i>
            <i class="fa-regular fa-paper-plane"></i>
            <i class="fa-regular fa-bookmark"></i>
          </div>
        </div>
        <div class="total-like">
          <a href="#" class="like-count">0</a><p>likes</p>
        </div>
        <div class="description">
          <p><a href="#">${savedPost.user}</a> ${savedPost.description}</p>
        </div>
        <div class="comment-views">
          <a href="#">No comments yet</a>
        </div>
        <div class="add-comments">
          <input type="text" class="comment-input" placeholder="Add a comment...">
          <button class="post-comment-btn" disabled>Post</button>
          <i class="fa-regular fa-face-smile"></i>
        </div>
      </div>
    `;
    
    allPosts.prepend(postEl);

    postForm.reset();
    previewImages.style.display = "none";
    selectPost.style.display = "none";
    
    showNotification("Post created successfully!", "success");

  } catch (err) {
    console.error("Error saving post:", err);
    showNotification("Error saving post!", "error");
  }
});

// ============ LOAD POSTS ============
async function getPosts() {
  try {
    const res = await fetch("http://localhost:3000/posts");
    if (!res.ok) throw new Error("Failed to fetch posts");

    const posts = await res.json();
    allPosts.innerHTML = "";

    posts.reverse().forEach(post => {
      const postEl = document.createElement("div");
      postEl.classList.add("post");
      postEl.dataset.id = post.id; // Important: Add post ID
      
      postEl.innerHTML = `
        <div class="post-images">
          <div class="post-header">
            <img src="../assets/images/profile1.jpg" alt="profile">
            <span class="username">${post.user}</span>
            <p class="post-time">${new Date(post.createdAt).toLocaleString()}</p>
            <i class="fa-solid fa-ellipsis"></i>
          </div>
          <div class="post-img">
            ${post.type === "image" 
              ? `<img src="${post.media}" alt="post image">`
              : `<video controls src="${post.media}"></video>`
            }
          </div>
          <div class="post-actions">
            <div class="post-comment">
              <i class="fa-regular fa-heart like-btn"></i>
              <i class="fa-regular fa-comment"></i>
              <i class="fa-regular fa-paper-plane"></i>
              <i class="fa-regular fa-bookmark"></i>
            </div>
          </div>
          <div class="total-like">
            <a href="#" class="like-count">${formatLikeCount(post.likes || 0)}</a><p>likes</p>
          </div>
          <div class="description">
            <p><a href="#">${post.user}</a> ${post.description || ''}</p>
          </div>
          <div class="comment-views">
            ${post.comments && post.comments.length > 0 
              ? `<a href="#">View all ${post.comments.length} comments</a>`
              : `<a href="#">No comments yet</a>`
            }
          </div>
          <div class="add-comments">
            <input type="text" class="comment-input" placeholder="Add a comment...">
            <button class="post-comment-btn" disabled>Post</button>
            <i class="fa-regular fa-face-smile"></i>
          </div>
        </div>
      `;
      allPosts.appendChild(postEl);
    });

    // Initialize like states after posts load
    setTimeout(() => initializeLikeStates(posts.reverse()), 100);

  } catch (err) {
    console.error("Error loading posts:", err);
    showNotification("Error loading posts!", "error");
  }
}

// ============ LIKE FUNCTIONALITY ============
function initializeLikeStates(posts) {
  const username = sessionStorage.getItem("username") || "Anonymous";
  
  posts.forEach((post, index) => {
    const postElement = document.querySelectorAll(".post")[index];
    if (!postElement) return;
    
    const heartIcon = postElement.querySelector(".fa-heart");
    const likedBy = post.likedBy || [];
    
    if (likedBy.includes(username)) {
      heartIcon.classList.remove("fa-regular");
      heartIcon.classList.add("fa-solid", "liked");
      heartIcon.style.color = "#ed4956";
    } else {
      heartIcon.classList.remove("fa-solid", "liked");
      heartIcon.classList.add("fa-regular");
      heartIcon.style.color = "#262626";
    }
  });
}

// Like button event handler
allPosts.addEventListener("click", async (e) => {
  if (e.target.classList.contains("fa-heart")) {
    e.preventDefault();
    
    const heartIcon = e.target;
    const postElement = heartIcon.closest(".post");
    const likeCountElement = postElement.querySelector(".like-count");
    const postId = postElement.dataset.id;
    
    if (!postId) {
      console.error("Post ID not found");
      return;
    }

    const username = sessionStorage.getItem("username") || "Anonymous";
    
    try {
      const response = await fetch(`http://localhost:3000/posts/${postId}`);
      if (!response.ok) throw new Error("Failed to fetch post data");
      
      const postData = await response.json();
      
      if (!postData.likedBy) postData.likedBy = [];
      
      const isLiked = postData.likedBy.includes(username);
      let newLikeCount = postData.likes || 0;
      
      if (isLiked) {
        // Unlike
        postData.likedBy = postData.likedBy.filter(user => user !== username);
        newLikeCount = Math.max(0, newLikeCount - 1);
        
        heartIcon.classList.remove("fa-solid", "liked");
        heartIcon.classList.add("fa-regular");
        heartIcon.style.color = "#262626";
        
      } else {
        // Like
        postData.likedBy.push(username);
        newLikeCount = newLikeCount + 1;
        
        heartIcon.classList.remove("fa-regular");
        heartIcon.classList.add("fa-solid", "liked");
        heartIcon.style.color = "#ed4956";
        
        heartIcon.style.transform = "scale(1.3)";
        setTimeout(() => {
          heartIcon.style.transform = "scale(1)";
        }, 150);
      }
      
      likeCountElement.textContent = formatLikeCount(newLikeCount);
      
      const updateResponse = await fetch(`http://localhost:3000/posts/${postId}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          likes: newLikeCount,
          likedBy: postData.likedBy
        })
      });
      
      if (!updateResponse.ok) {
        throw new Error("Failed to update like status");
      }
      
    } catch (error) {
      console.error("Error updating like status:", error);
      showNotification("Failed to update like. Please try again.", "error");
    }
  }
});



















// ============ COMMENT SECTION ============
allPosts.addEventListener("input", (e) => {
  if (e.target.classList.contains("comment-input")) {
    const postBtn = e.target.closest(".add-comments").querySelector(".post-comment-btn");
    postBtn.style.display = e.target.value.trim() ? "inline-block" : "none";
    postBtn.disabled = !e.target.value.trim();
  }
});

allPosts.addEventListener("click", async (e) => {
  if (e.target.classList.contains("post-comment-btn")) {
    const commentBtn = e.target;
    const commentInput = commentBtn.closest(".add-comments").querySelector(".comment-input");
    const commentText = commentInput.value.trim();

    if (!commentText) return;

    const postEl = commentBtn.closest(".post");
    const username = sessionStorage.getItem("username") || "Anonymous";

    let commentViews = postEl.querySelector(".comment-views");
    
    if (commentViews.textContent.includes("No comments yet")) {
      commentViews.innerHTML = '';
    }

    const newComment = document.createElement("p");
    newComment.innerHTML = `<strong>${username}</strong> ${commentText}`;
    commentViews.appendChild(newComment);

    commentInput.value = "";
    commentBtn.style.display = "none";
    commentBtn.disabled = true;
  }
});

// ============ INITIALIZE ============
document.addEventListener("DOMContentLoaded", () => {
  getPosts();
});


allPosts.addEventListener("input", (e) => {
  if (e.target.classList.contains("comment-input")) {
    const postBtn = e.target.closest(".add-comments").querySelector(".post-comment-btn");
    postBtn.style.display = e.target.value.trim() ? "inline-block" : "none";
    postBtn.disabled = !e.target.value.trim();
  }
});



// commnet-section

// ============ COMMENT INPUT & POST BUTTON ============
allPosts.addEventListener("input", (e) => {
  if (e.target.classList.contains("comment-input")) {
    const postBtn = e.target.closest(".add-comments").querySelector(".post-comment-btn");
    postBtn.style.display = e.target.value.trim() ? "inline-block" : "none";
    postBtn.disabled = !e.target.value.trim();
  }
});

// ============ ADD COMMENT ============
allPosts.addEventListener("click", async (e) => {
  if (e.target.classList.contains("post-comment-btn")) {
    const commentBtn = e.target;
    const commentInput = commentBtn.closest(".add-comments").querySelector(".comment-input");
    const commentText = commentInput.value.trim();

    if (!commentText) return;

    const postEl = commentBtn.closest(".post");
    const postId = postEl.dataset.id; // assuming you set data-id for each post
    const username = sessionStorage.getItem("username") || "Anonymous";

    // save comment in db.json
    const res = await fetch(`http://localhost:3000/posts/${postId}`);
    const post = await res.json();

    const newComment = { username, text: commentText };
    const updatedComments = [...(post.comments || []), newComment];

    await fetch(`http://localhost:3000/posts/${postId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comments: updatedComments }),
    });

    // append new comment to UI
    let commentViews = postEl.querySelector(".comment-views");
    if (commentViews.textContent.includes("No comments yet")) {
      commentViews.innerHTML = "";
    }

    const commentEl = document.createElement("p");
    commentEl.innerHTML = `<strong>${username}</strong> ${commentText}`;
    commentViews.appendChild(commentEl);

    commentInput.value = "";
    commentBtn.style.display = "none";
    commentBtn.disabled = true;
  }
});

// ============ VIEW ALL COMMENTS ============
allPosts.addEventListener("click", async (e) => {
  if (e.target.classList.contains("view-all-comments")) {
    const postEl = e.target.closest(".post");
    const postId = postEl.dataset.id; // post id
    const commentViews = postEl.querySelector(".comment-views");

    // fetch full post with comments
    const res = await fetch(`http://localhost:3000/posts/${postId}`);
    const post = await res.json();

    commentViews.innerHTML = ""; // clear
    if (!post.comments || post.comments.length === 0) {
      commentViews.innerHTML = "<p>No comments yet</p>";
      return;
    }

    post.comments.forEach((c) => {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${c.username}</strong> ${c.text}`;
      commentViews.appendChild(p);
    });
  }
});




// ============ INITIALIZE ============
document.addEventListener("DOMContentLoaded", () => {
  getPosts();
});



document.addEventListener("DOMContentLoaded", () => {
  getPosts();
});

</script> -->



<script>
// ============ SELECT ELEMENTS ============
const allPosts = document.getElementById("all-posts");
const postForm = document.querySelector(".post-form");
const mediaInput = document.getElementById("media");
const fileURL = document.getElementById("fileURL");
const previewImages = document.getElementById("previewImage");
const descriptionInput = document.getElementById("description");

// ============ UTILITY FUNCTIONS ============
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

function formatLikeCount(count) {
  if (count >= 1000000) return (count / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
  if (count >= 1000) return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
  return count.toLocaleString();
}

function showNotification(message, type = "info") {
  const notification = document.createElement("div");
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => notification.style.opacity = "1", 10);
  setTimeout(() => {
    notification.style.opacity = "0";
    setTimeout(() => {
      if (document.body.contains(notification)) document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// ============ POST CREATION ============
postForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = mediaInput.files[0];
  const description = descriptionInput.value.trim();
  const username = sessionStorage.getItem("username") || "Anonymous";

  if (!file) return showNotification("Please select an image or video!", "error");

  try {
    const base64Media = await toBase64(file);
    const newPost = {
      user: username,
      description,
      media: base64Media,
      type: file.type.startsWith("image/") ? "image" : "video",
      likes: 0,
      likedBy: [],
      comments: [],
      createdAt: new Date().toISOString()
    };

    const res = await fetch("http://localhost:3000/posts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newPost)
    });

    if (!res.ok) throw new Error("Failed to save post");
    const savedPost = await res.json();
    addPostToUI(savedPost, true);

    postForm.reset();
    previewImages.style.display = "none";
    showNotification("Post created successfully!", "success");
  } catch (err) {
    console.error(err);
    showNotification("Error saving post!", "error");
  }
});

// ============ LOAD POSTS ============
async function getPosts() {
  try {
    const res = await fetch("http://localhost:3000/posts");
    if (!res.ok) throw new Error("Failed to fetch posts");
    const posts = await res.json();
    allPosts.innerHTML = "";
    posts.reverse().forEach(post => addPostToUI(post));
  } catch (err) {
    console.error(err);
    showNotification("Error loading posts!", "error");
  }
}
// ============ ADD POST TO UI ============
function addPostToUI(post, prepend = false) {
  const postEl = document.createElement("div");
  postEl.classList.add("post");
  postEl.dataset.id = post.id;
  postEl.innerHTML = `
    <div class="post-images">
      <div class="post-header">
        <img src="../assets/images/profile1.jpg" alt="profile">
        <span class="username">${post.user}</span>
        <p class="post-time">${new Date(post.createdAt).toLocaleString()}</p>
        <i class="fa-solid fa-ellipsis"></i>
      </div>
      <div class="post-img">
        ${post.type === "image" ? `<img src="${post.media}" alt="post image">` : `<video controls src="${post.media}"></video>`}
      </div>
      <div class="post-actions">
        <div class="post-comment">
          <i class="fa-regular fa-heart like-btn"></i>
          <i class="fa-regular fa-comment"></i>
          <i class="fa-regular fa-paper-plane"></i>
          <i class="fa-regular fa-bookmark"></i>
        </div>
      </div>
      <div class="total-like">
        <a href="#" class="like-count">${formatLikeCount(post.likes)}</a><p>likes</p>
      </div>
      <div class="description">
        <p><a href="#">${post.user}</a> ${post.description || ''}</p>
      </div>
      <div class="comment-views">
        ${post.comments.length > 0 ? '' : '<p>No comments yet</p>'}
      </div>
      <div class="add-comments">
        <input type="text" class="comment-input" placeholder="Add a comment...">
        <button class="post-comment-btn" disabled>Post</button>
        <i class="fa-regular fa-face-smile"></i>
      </div>
    </div>
  `;
  
  // Append all existing comments
  const commentViews = postEl.querySelector(".comment-views");
  post.comments.forEach(c => {
    const p = document.createElement("p");
    p.innerHTML = `<strong>${c.username}</strong> ${c.text}`;
    commentViews.appendChild(p);
  });

  if (prepend) allPosts.prepend(postEl);
  else allPosts.appendChild(postEl);

  // Initialize like button
  initializeLikeButton(postEl, post);
}

// ============ LIKE FUNCTIONALITY ============
function initializeLikeButton(postEl, post) {
  const heartIcon = postEl.querySelector(".like-btn");
  const likeCountElement = postEl.querySelector(".like-count");
  const username = sessionStorage.getItem("username") || "Anonymous";

  if (post.likedBy.includes(username)) {
    heartIcon.classList.replace("fa-regular", "fa-solid");
    heartIcon.classList.add("liked");
    heartIcon.style.color = "#ed4956";
  }

  heartIcon.addEventListener("click", async () => {
    try {
      const res = await fetch(`http://localhost:3000/posts/${post.id}`);
      const postData = await res.json();
      let newLikeCount = postData.likes || 0;

      if (postData.likedBy.includes(username)) {
        // Unlike
        postData.likedBy = postData.likedBy.filter(u => u !== username);
        newLikeCount = Math.max(0, newLikeCount - 1);
        heartIcon.classList.replace("fa-solid", "fa-regular");
        heartIcon.classList.remove("liked");
        heartIcon.style.color = "#262626";
      } else {
        // Like
        postData.likedBy.push(username);
        newLikeCount += 1;
        heartIcon.classList.replace("fa-regular", "fa-solid");
        heartIcon.classList.add("liked");
        heartIcon.style.color = "#ed4956";
        heartIcon.style.transform = "scale(1.3)";
        setTimeout(() => heartIcon.style.transform = "scale(1)", 150);
      }

      likeCountElement.textContent = formatLikeCount(newLikeCount);

      await fetch(`http://localhost:3000/posts/${post.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ likes: newLikeCount, likedBy: postData.likedBy })
      });
    } catch (err) {
      console.error(err);
      showNotification("Error updating like!", "error");
    }
  });
}

// ============ COMMENT FUNCTIONALITY ============
allPosts.addEventListener("input", (e) => {
  if (e.target.classList.contains("comment-input")) {
    const postBtn = e.target.closest(".add-comments").querySelector(".post-comment-btn");
    postBtn.style.display = e.target.value.trim() ? "inline-block" : "none";
    postBtn.disabled = !e.target.value.trim();
  }
});

allPosts.addEventListener("click", async (e) => {
  if (e.target.classList.contains("post-comment-btn")) {
    const commentBtn = e.target;
    const commentInput = commentBtn.closest(".add-comments").querySelector(".comment-input");
    const commentText = commentInput.value.trim();
    if (!commentText) return;

    const postEl = commentBtn.closest(".post");
    const postId = postEl.dataset.id;
    const username = sessionStorage.getItem("username") || "Anonymous";

    try {
      const res = await fetch(`http://localhost:3000/posts/${postId}`);
      const postData = await res.json();
      const updatedComments = [...(postData.comments || []), { username, text: commentText }];

      await fetch(`http://localhost:3000/posts/${postId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ comments: updatedComments })
      });

      // Update UI
      const commentViews = postEl.querySelector(".comment-views");
      commentViews.innerHTML = "";
      updatedComments.forEach(c => {
        const p = document.createElement("p");
        p.innerHTML = `<strong>${c.username}</strong> ${c.text}`;
        commentViews.appendChild(p);
      });

      commentInput.value = "";
      commentBtn.style.display = "none";
      commentBtn.disabled = true;
    } catch (err) {
      console.error(err);
      showNotification("Error adding comment!", "error");
    }
  }
});

// ============ INITIALIZE ============
document.addEventListener("DOMContentLoaded", getPosts);

</script>

</body>
</html>